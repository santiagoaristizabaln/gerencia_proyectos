name: CI

on:
  push:
    # Ejecuta el pipeline en los pushes a main y tu rama de trabajo
    branches: [ main ]
  pull_request:
    # Ejecuta el pipeline cuando se crea un PR contra estas ramas
    branches: [ main ]
  # Permite ejecutar la acción manualmente desde la UI de GitHub
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository and DVC files
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install core and dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dvc[gdrive]==3.* mlflow==2.* pandas==2.* scikit-learn==1.* joblib==1.* numpy==1.*
          pip install pre-commit==3.* flake8==7.* pytest==8.*

      - name: Descargar dataset desde Google Drive
        run: |
          # Descarga el archivo UCI_Credit_Card.csv
          curl -L \
            "https://drive.google.com/uc?export=download&id=16__jHyBkvSlL-VSCKyC-9cMC8ZmXNMnY" \
            -o data/raw/UCI_Credit_Card.csv

      - name: Configurar Remoto DVC
        run: |
          dvc remote add -d gdrive-remote gdrive://https://drive.google.com/file/d/16__jHyBkvSlL-VSCKyC-9cMC8ZmXNMnY/view?usp=share_link
      
      - name: DVC pull (Descargar Artefactos Rastreados)
        run: |
          # Descarga todos los demás archivos rastreados por DVC (modelos, datos intermedios)
          if [ -d .dvc ] || [ -f dvc.yaml ]; then
            dvc pull || (echo "::error::dvc pull failed to retrieve data"; exit 1)
          else
            echo "No DVC project detected. Skipping DVC pull."
          fi

      - name: DVC repro (Run MLOps Pipeline)
        run: |
          # Ahora dvc repro debería encontrar todos los archivos necesarios.
          if [ -d .dvc ] || [ -f dvc.yaml ]; then
            dvc repro --no-commit || (echo "::error::dvc repro failed in pipeline execution"; exit 1)
          else
            echo "No DVC project detected. Skipping dvc repro."
          fi