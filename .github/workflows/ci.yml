name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository and DVC files
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install core and dev dependencies
        run: |
          python -m pip install --upgrade pip
          # Instalamos DVC y librerías principales (sin patrones raros de versión)
          pip install "dvc[gs,s3]" mlflow pandas scikit-learn joblib numpy
          pip install pre-commit flake8 pytest

      - name: Crear carpetas base (por si acaso)
        run: |
          mkdir -p data/raw data/processed models

      - name: Descargar dataset desde Google Drive
        run: |
          curl -L             "https://drive.google.com/uc?export=download&id=16__jHyBkvSlL-VSCKyC-9cMC8ZmXNMnY"             -o data/raw/UCI_Credit_Card.csv
      
      - name: DVC pull (si hay remoto configurado)
        run: |
          if [ -d .dvc ] || [ -f dvc.yaml ]; then
            # Solo intentamos dvc pull si existe al menos un remote configurado
            if dvc remote list | grep -q .; then
              echo "Remote DVC detectado. Ejecutando dvc pull..."
              dvc pull || (echo "::warning::dvc pull failed to retrieve data, se recalcularán artefactos con dvc repro"; exit 0)
            else
              echo "No hay remoto DVC configurado. Se omite 'dvc pull' y 'dvc repro' recalculará los artefactos."
            fi
          else
            echo "No DVC project detected. Skipping DVC pull."
          fi

      - name: DVC repro (Run MLOps Pipeline)
        run: |
          if [ -d .dvc ] || [ -f dvc.yaml ]; then
            dvc repro --no-commit || (echo "::error::dvc repro failed in pipeline execution"; exit 1)
          else
            echo "No DVC project detected. Skipping dvc repro."
          fi
